generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Workspace {
  id            String            @id @default(uuid())
  name          String
  ownerId       String
  createdAt     DateTime          @default(now())
  icon          String?
  slug          String?           @unique
  mentions      Mentions[]
  notifications Notification[]
  pages         Page[]
  tasks         Tasks[]
  members       WorkspaceMember[]
}

model Page {
  id          String        @id @default(uuid())
  workspaceId String
  title       String
  icon        String?
  cover       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  private     Boolean       @default(false)
  blocks      Block[]
  favorites   Favorite[]
  mentions    Mentions[]
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  snapshots   YjsSnapshot[]
}

model Block {
  id           String         @id @default(uuid())
  pageId       String
  parentId     String?
  type         String
  content      Json
  order        Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  lastSyncedAt DateTime?
  page         Page           @relation(fields: [pageId], references: [id])
  parent       Block?         @relation("BlockChildren", fields: [parentId], references: [id])
  children     Block[]        @relation("BlockChildren")
  versions     BlockVersion[]
  comments     Comment[]
}

model Favorite {
  userId String
  pageId String
  page   Page   @relation(fields: [pageId], references: [id])

  @@id([userId, pageId])
}

model WorkspaceMember {
  id            String    @id @default(uuid())
  workspaceId   String
  userId        String
  role          String
  createdAt     DateTime  @default(now())
  name          String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedTasks Tasks[]   @relation("TasksToWorkspaceMember")

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(uuid())
  blockId   String
  userId    String
  content   String
  createdAt DateTime @default(now())
  block     Block    @relation(fields: [blockId], references: [id])
}

model BlockVersion {
  id        String   @id @default(uuid())
  blockId   String
  content   Json
  createdAt DateTime @default(now())
  changedBy String
  block     Block    @relation(fields: [blockId], references: [id])
}

model Tasks {
  id          String            @id @default(uuid())
  workspaceId String
  title       String
  status      String            @default("pending")
  priority    String            @default("low")
  createdAt   DateTime          @default(now())
  dueDate     DateTime?
  workspace   Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignees   WorkspaceMember[] @relation("TasksToWorkspaceMember")
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  type        String
  message     String
  createdAt   DateTime  @default(now())
  read        Boolean   @default(false)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Mentions {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  mentionedBy String
  pageId      String
  createdAt   DateTime  @default(now())
  page        Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model YjsSnapshot {
  id        String   @id @default(uuid())
  pageId    String
  snapshot  Bytes
  version   Int
  createdAt DateTime @default(now())
  createdBy String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([createdAt])
}
